In urban rail transit, hybrid energy storage system (HESS) is often designed to achieve “peak shaving and valley filling” and smooth out DC traction network power fluctuation. In this paper, a variable gain K iterative learning control (K-ILC) is proposed to balance the DC regulated voltage characteristics and the optimal lifetime of the battery storage system in the HESS. Firstly, according to the traction power demand obtained from the train running speed demand, a moving average filters algorithm (MAF) is used to assign the high-frequency power command to the onboard ultracapacitors and the low-frequency power command to the batteries and traction network, respectively. Then, in order to prolong the battery life, a variable gain ratio is introduced in the traditional PD open-loop iterative learning control by designing the power allocation switching rules and the optimal change trajectory of battery life. This will provide the control of the battery charging and discharging current so as to prevent overcharge and overdischarge. To verify the effectiveness of the proposed strategy, experiments are performed both in MATLAB/Simulink and in the RT-LAB semi-Physical real-time simulation system. The experimental results show that the proposed control strategy effectively stabilizes the bus voltage and extends the battery lifetime.