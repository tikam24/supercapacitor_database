The hybrid energy storage system (HESS) is composed of lithium-ion battery packs and supercapacitors (SCs), it can better stabilize the output of photovoltaic (PV) in the microgrid. The wavelet packet analysis method is used to decompose the output power of PV, and the power components of different frequency bands can be obtained. However, the traditional wavelet packet decomposition method has a fixed number of decomposition layers and cannot track changes in the output power of PV in real time. This paper proposes an improved wavelet packet decomposition method: considering the fluctuation of solar cell output power and the current working status of the HESS, the fuzzy control algorithm is used to adjust the number of wavelet packet layers in real-time to realize the adaptive process of power fluctuation in the stable process, and taking into account the state of charge of lithium-ion batteries and SCs, fuzzy control is used to allocate their secondary output power to improve the stability effect. Experiments show that compared with the traditional wavelet packet-based control method, the control method proposed in this paper improves the control effect by 4.5%.