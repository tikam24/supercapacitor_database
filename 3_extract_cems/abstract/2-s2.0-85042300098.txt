This paper proposes a methodology for optimal operation of railway electric energy systems considering renewable energy sources (PV panels and wind turbines), regenerative braking capabilities and hybrid electric energy storage systems (ultracapacitors and batteries). The uncertainties associated to renewable energies are taken into account through a scenario tree approach. All these elements are integrated into a multiperiod AC optimal power flow problem. This problem is then cast as a large-scale nonlinear optimization problem. The aim is to study the potential for energy and economic savings of the railway operation as well as energy storage systems behavior. A real case study is analyzed for a Spanish high-speed railway line. Results are reported for several cases comparing four different operation modes.