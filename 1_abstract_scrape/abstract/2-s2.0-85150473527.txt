In this work, a photovoltaic (PV) microinverter is developed, which includes an hybrid energy storage system based on a battery and an ultracapacitor that are connected in parallel to the dc-link through two buck-boost bidirectional converters. The PV panel is connected in parallel to dc-link through an unidirectional boost converter. For the dc-ac stage, a two-stage Flyback / H-bridge inverter will be considered, which will be used to inject the available power into a microgrid. The study proposes the necessary control strategies to manage the power flow according to generation and injection conditions, where a virtual impedance loop is incorporated in the control of the energy storage elements. The presented results confirm the suitability of the proposed strategy.