Although the stability of the grid-connected photovoltaics (PV) and energy storage systems under weak grids has been widely researched, the classical improvement methods focus more on suppressing the harmonics introduced by the phase-locked loop (PLL). Furthermore, the current distortion caused by the DC voltage loop is difficult to be eliminated. In this study, based on the hybrid energy storage system of battery-supercapacitor, a dual-loop compensation method is proposed. First, the small-signal model and output impedance matrix are built in d-q axis. Second, for different disturbance loops, a DC voltage loop disturbance compensation method based on power feedforward is proposed to suppress the harmonics caused by the DC voltage controller (DVC). In addition, a voltage feedforward PLL disturbance compensation method is proposed, which can reduce the PLL perturbations and revise the output impedance to improve system stability. Finally, the output impedance frequency characteristic analysis and the hardware-in-the-loop (HIL) simulation results show that the proposed control method can effectively improve the stability of the system under weak grids.